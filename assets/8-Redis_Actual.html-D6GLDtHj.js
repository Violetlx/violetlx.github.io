import{_ as s,c as a,b as p,o as t}from"./app-BY1XJ_0O.js";const e="/assets/1653574849336-BASnu_Ih.png",c="/assets/image-20250619095630154-uiXlq5dC.png",l="/assets/1653575506373-YZtuCxK_.png",o="/assets/1653577301737-CEgqD1BM.png",i="/assets/1653577349691-IVUawIJI.png",u="/assets/1653577445413-CtF0L7bY.png",r="/assets/1653577643629-DJzdX_Y_.png",k="/assets/1653577659166-Dn1JQ3uu.png",d="/assets/1653577689129-CvOQnRlP.png",m="/assets/1653577801668-C7FzF37x.png",v="data:image/png;base64,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",b="/assets/1653578211854-zmHOhpCb.png",g="/assets/image-20250619095851129-DIXs-dtT.png",h="/assets/image-20250619103123505-Cs8qtl6_.png",R={};function f(O,n){return t(),a("div",null,n[0]||(n[0]=[p('<p><img src="https://bizhi1.com/wp-content/uploads/2025/04/yamato-one-piece-flaming-sword-anime-girl-desktop-wallpaper-4k.jpg" alt="大和号海贼王火焰剑动漫女孩桌面壁纸"></p><div class="custom-container tip"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">TIP</p><p>① 认识消息队列</p><p>② 基于List实现消息队列</p><p>③ 基于PubSub的消息队列</p><p>④ 基于Stream的消息队列</p><p>⑤ 基于Stream的消息队列-消费者组</p><p>⑥ 基于Redis的Stream结构作为消息队列，实现异步秒杀下单</p></div><h2 id="_1-认识消息队列" tabindex="-1"><a class="header-anchor" href="#_1-认识消息队列"><span>① 认识消息队列</span></a></h2><p>什么是消息队列：字面意思就是存放消息的队列。最简单的消息队列模型包括3个角色：</p><ul><li>消息队列：存储和管理消息，也被称为消息代理（Message Broker）</li><li>生产者：发送消息到消息队列</li><li>消费者：从消息队列获取消息并处理消息</li></ul><p><img src="'+e+'" alt="1653574849336"></p><p>使用队列的好处在于 **解耦：**所谓解耦，举一个生活中的例子就是：快递员(生产者)把快递放到快递柜里边(Message Queue)去，我们(消费者)从快递柜里边去拿东西，这就是一个异步，如果耦合，那么这个快递员相当于直接把快递交给你，这事固然好，但是万一你不在家，那么快递员就会一直等你，这就浪费了快递员的时间，所以这种思想在我们日常开发中，是非常有必要的。</p><p>这种场景在我们秒杀中就变成了：我们下单之后，利用redis去进行校验下单条件，再通过队列把消息发送出去，然后再启动一个线程去消费这个消息，完成解耦，同时也加快我们的响应速度。</p><p>这里我们可以使用一些现成的mq，比如kafka，rabbitmq等等，但是呢，如果没有安装mq，我们也可以直接使用redis提供的mq方案，降低我们的部署和学习成本。</p><h2 id="_2-基于list实现消息队列" tabindex="-1"><a class="header-anchor" href="#_2-基于list实现消息队列"><span>② 基于List实现消息队列</span></a></h2><p><strong>基于List结构模拟消息队列</strong></p><p>消息队列（Message Queue），字面意思就是存放消息的队列。而Redis的list数据结构是一个双向链表，很容易模拟出队列效果。</p><p>队列是入口和出口不在一边，因此我们可以利用：LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。<br> 不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。因此这里应该使用BRPOP或者BLPOP来实现阻塞效果。</p><p><img src="'+c+'" alt="image-20250619095630154"></p><p>基于List的消息队列有哪些优缺点？<br> 优点：</p><ul><li>利用Redis存储，不受限于JVM内存上限</li><li>基于Redis的持久化机制，数据安全性有保证</li><li>可以满足消息有序性</li></ul><p>缺点：</p><ul><li>无法避免消息丢失</li><li>只支持单消费者</li></ul><h2 id="_3-基于pubsub的消息队列" tabindex="-1"><a class="header-anchor" href="#_3-基于pubsub的消息队列"><span>③ 基于PubSub的消息队列</span></a></h2><p>PubSub（发布订阅）是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。</p><p>SUBSCRIBE channel [channel] ：订阅一个或多个频道<br> PUBLISH channel msg ：向一个频道发送消息<br> PSUBSCRIBE pattern[pattern] ：订阅与pattern格式匹配的所有频道</p><p><img src="'+l+'" alt="1653575506373"></p><p>基于PubSub的消息队列有哪些优缺点？<br> 优点：</p><ul><li>采用发布订阅模型，支持多生产、多消费</li></ul><p>缺点：</p><ul><li>不支持数据持久化</li><li>无法避免消息丢失</li><li>消息堆积有上限，超出时数据丢失</li></ul><h2 id="_4-基于stream的消息队列" tabindex="-1"><a class="header-anchor" href="#_4-基于stream的消息队列"><span>④ 基于Stream的消息队列</span></a></h2><p>Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列。</p><p>发送消息的命令：</p><p><img src="'+o+'" alt="1653577301737"></p><p>例如：</p><p><img src="'+i+'" alt="1653577349691"></p><p>读取消息的方式之一：XREAD</p><p><img src="'+u+'" alt="1653577445413"></p><p>例如，使用XREAD读取第一个消息：</p><p><img src="'+r+'" alt="1653577643629"></p><p>XREAD阻塞方式，读取最新的消息：</p><p><img src="'+k+'" alt="1653577659166"></p><p>在业务开发中，我们可以循环的调用XREAD阻塞方式来查询最新消息，从而实现持续监听队列的效果，伪代码如下</p><p><img src="'+d+'" alt="1653577689129"></p><p>注意：当我们指定起始ID为$时，代表读取最新的消息，如果我们处理一条消息的过程中，又有超过1条以上的消息到达队列，则下次获取时也只能获取到最新的一条，会出现漏读消息的问题</p><p>STREAM类型消息队列的XREAD命令特点：</p><ul><li>消息可回溯</li><li>一个消息可以被多个消费者读取</li><li>可以阻塞读取</li><li>有消息漏读的风险</li></ul><h2 id="_5-基于stream的消息队列-消费者组" tabindex="-1"><a class="header-anchor" href="#_5-基于stream的消息队列-消费者组"><span>⑤ 基于Stream的消息队列-消费者组</span></a></h2><p>消费者组（Consumer Group）：将多个消费者划分到一个组中，监听同一个队列。具备下列特点：</p><p><img src="'+m+'" alt="1653577801668"></p><p>创建消费者组：<br><img src="'+v+`" alt="1653577984924"><br> key：队列名称<br> groupName：消费者组名称<br> ID：起始ID标示，$代表队列中最后一个消息，0则代表队列中第一个消息<br> MKSTREAM：队列不存在时自动创建队列<br> 其它常见命令：</p><p><strong>删除指定的消费者组</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token constant">XGROUP</span> <span class="token constant">DESTORY</span> key groupName</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>给指定的消费者组添加消费者</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token constant">XGROUP</span> <span class="token constant">CREATECONSUMER</span> key groupname consumername</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>删除消费者组中的指定消费者</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token constant">XGROUP</span> <span class="token constant">DELCONSUMER</span> key groupname consumername</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>从消费者组读取消息：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token constant">XREADGROUP</span> <span class="token constant">GROUP</span> group consumer <span class="token punctuation">[</span><span class="token constant">COUNT</span> count<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">BLOCK</span> milliseconds<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">NOACK</span><span class="token punctuation">]</span> <span class="token constant">STREAMS</span> key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token constant">ID</span> <span class="token punctuation">[</span><span class="token constant">ID</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>group：消费组名称</li><li>consumer：消费者名称，如果消费者不存在，会自动创建一个消费者</li><li>count：本次查询的最大数量</li><li>BLOCK milliseconds：当没有消息时最长等待时间</li><li>NOACK：无需手动ACK，获取到消息后自动确认</li><li>STREAMS key：指定队列名称</li><li>ID：获取消息的起始ID：</li></ul><p>&quot;&gt;&quot;：从下一个未消费的消息开始<br> 其它：根据指定id从pending-list中获取已消费但未确认的消息，例如0，是从pending-list中的第一个消息开始</p><p>消费者监听消息的基本思路：</p><p><img src="`+b+'" alt="1653578211854"></p><p>STREAM类型消息队列的XREADGROUP命令特点：</p><ul><li>消息可回溯</li><li>可以多消费者争抢消息，加快消费速度</li><li>可以阻塞读取</li><li>没有消息漏读的风险</li><li>有消息确认机制，保证消息至少被消费一次</li></ul><p>最后我们来个小对比</p><p><img src="'+g+'" alt="image-20250619095851129"></p><h2 id="_6-基于redis的stream结构作为消息队列-实现异步秒杀下单" tabindex="-1"><a class="header-anchor" href="#_6-基于redis的stream结构作为消息队列-实现异步秒杀下单"><span>⑥ 基于Redis的Stream结构作为消息队列，实现异步秒杀下单</span></a></h2><p>需求：</p><ul><li>创建一个Stream类型的消息队列，名为stream.orders</li><li>修改之前的秒杀下单Lua脚本，在认定有抢购资格后，直接向stream.orders中添加消息，内容包含voucherId、userId、orderId</li><li>项目启动时，开启一个线程任务，尝试获取stream.orders中的消息，完成下单\\</li></ul><p>修改lua表达式,新增3.6</p><p><img src="'+h+`" alt="image-20250619103123505"></p><p>VoucherOrderServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 1.获取消息队列中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span></span>
<span class="line">                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 2.判断订单信息是否为空</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 如果为null，说明没有消息，继续下一次循环</span></span>
<span class="line">                    <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">// 解析数据</span></span>
<span class="line">                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 3.创建订单</span></span>
<span class="line">                <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 4.确认消息 XACK</span></span>
<span class="line">                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理订单异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//处理异常消息</span></span>
<span class="line">                <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 1.获取pending-list中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span></span>
<span class="line">                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 2.判断订单信息是否为空</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 如果为null，说明没有异常消息，结束循环</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">// 解析数据</span></span>
<span class="line">                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 3.创建订单</span></span>
<span class="line">                <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 4.确认消息 XACK</span></span>
<span class="line">                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理pendding订单异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">try</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,70)]))}const E=s(R,[["render",f]]),I=JSON.parse('{"path":"/docs/Middleware/Redis/Redis_Heima/2_Redis_Actual/8-Redis_Actual.html","title":"Redis消息队列","lang":"en-US","frontmatter":{"title":"Redis消息队列","date":"2025/06/19"},"headers":[{"level":2,"title":"① 认识消息队列","slug":"_1-认识消息队列","link":"#_1-认识消息队列","children":[]},{"level":2,"title":"② 基于List实现消息队列","slug":"_2-基于list实现消息队列","link":"#_2-基于list实现消息队列","children":[]},{"level":2,"title":"③ 基于PubSub的消息队列","slug":"_3-基于pubsub的消息队列","link":"#_3-基于pubsub的消息队列","children":[]},{"level":2,"title":"④ 基于Stream的消息队列","slug":"_4-基于stream的消息队列","link":"#_4-基于stream的消息队列","children":[]},{"level":2,"title":"⑤ 基于Stream的消息队列-消费者组","slug":"_5-基于stream的消息队列-消费者组","link":"#_5-基于stream的消息队列-消费者组","children":[]},{"level":2,"title":"⑥ 基于Redis的Stream结构作为消息队列，实现异步秒杀下单","slug":"_6-基于redis的stream结构作为消息队列-实现异步秒杀下单","link":"#_6-基于redis的stream结构作为消息队列-实现异步秒杀下单","children":[]}],"filePathRelative":"docs/Middleware/Redis/Redis_Heima/2_Redis_Actual/8-Redis_Actual.md","git":{"createdTime":1750319780000,"updatedTime":1750319780000,"contributors":[{"name":"lixuan","email":"2789968443@qq.com","commits":1}]}}');export{E as comp,I as data};
